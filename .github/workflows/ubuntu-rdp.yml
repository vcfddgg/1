name: Ubuntu GNOME + VNC (Tailscale, 6h)

on:
  workflow_dispatch:
    inputs:
      tailscale_authkey:
        description: "Tailscale Auth Key (ephemeral or reusable)"
        required: true
      username:
        description: "Login username"
        required: false
        default: "runner"
      password:
        description: "Login password"
        required: false
        default: "runner"
      desktop:
        description: "Desktop (gnome=stable flashback, gnome-classic, xfce)"
        type: choice
        options: [gnome, gnome-classic, xfce]
        default: "gnome"
      runtime_minutes:
        description: "Minutes to keep session alive (max 360)"
        required: false
        default: "355"

permissions:
  contents: read

jobs:
  vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 370
    env:
      USERNAME: ${{ github.event.inputs.username || 'runner' }}
      PASSWORD: ${{ github.event.inputs.password || 'runner' }}
      TS_AUTHKEY: ${{ github.event.inputs.tailscale_authkey }}
      TS_HOSTNAME: gh-gnome-vnc-${{ github.run_id }}
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '355' }}
      DESKTOP: ${{ github.event.inputs.desktop || 'gnome' }}

    steps:
      - name: Prepare user + sudo
        run: |
          set -euo pipefail
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install base desktop bits (GNOME or XFCE) + VNC
        run: |
          set -euo pipefail
          sudo apt-get update -qq

          # Always install TigerVNC server + helpers
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            tigervnc-standalone-server tigervnc-common tigervnc-tools \
            dbus-x11 xorg

          if [ "${DESKTOP}" = "xfce" ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
              xfce4 xfce4-goodies
            echo "exec startxfce4" | sudo tee /home/${USERNAME}/.xsession >/dev/null
          else
            # Official GNOME stack
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
              gnome-session gnome-shell gnome-terminal gnome-control-center \
              gdm3 gnome-tweaks gnome-shell-extension-prefs

            # Headless stability: use Xorg, disable Wayland and shell extensions, software-friendly settings
            sudo sed -i 's/^#\?WaylandEnable=.*/WaylandEnable=false/' /etc/gdm3/custom.conf || true
            sudo bash -lc "mkdir -p /home/${USERNAME}/.config"

            # Disable user extensions, animations, idle, etc. (prevents 'Oh no!' crashes)
            sudo -u ${USERNAME} dbus-launch gsettings set org.gnome.shell disable-user-extensions true
            sudo -u ${USERNAME} dbus-launch gsettings set org.gnome.desktop.interface enable-animations false
            sudo -u ${USERNAME} dbus-launch gsettings set org.gnome.desktop.session idle-delay 0
            sudo -u ${USERNAME} dbus-launch gsettings set org.gnome.mutter check-alive-timeout 0

            if [ "${DESKTOP}" = "gnome-classic" ]; then
              # GNOME Flashback (metacity) is very robust in virtual/CPU rendering
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq gnome-session-flashback
              echo "exec dbus-launch gnome-session --session=gnome-flashback-metacity" | sudo tee /home/${USERNAME}/.xsession >/dev/null
            else
              # Default 'gnome' option -> also use Flashback (stable) while remaining GNOME
              sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq gnome-session-flashback
              echo "exec dbus-launch gnome-session --session=gnome-flashback-metacity" | sudo tee /home/${USERNAME}/.xsession >/dev/null
            fi
          fi

          sudo chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.xsession

          # VNC password
          sudo -u ${USERNAME} mkdir -p /home/${USERNAME}/.vnc
          echo "${PASSWORD}" | vncpasswd -f | sudo tee /home/${USERNAME}/.vnc/passwd >/dev/null
          sudo chmod 600 /home/${USERNAME}/.vnc/passwd
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc

      - name: Install + bring up Tailscale
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          sudo tailscale up --authkey "${TS_AUTHKEY}" --hostname "${TS_HOSTNAME}"
          sudo tailscale status || true

      - name: Start TigerVNC on :1 (5901)
        run: |
          set -euo pipefail
          # Start a clean VNC session reachable over the private Tailscale IP
          sudo -u ${USERNAME} vncserver -kill :1 >/dev/null 2>&1 || true
          sudo -u ${USERNAME} vncserver :1 -geometry 1280x800 -depth 24 -localhost no
          sleep 2
          # Show processes
          pgrep -a Xvnc || true

      - name: Connection info
        run: |
          set -euo pipefail
          TS4=$(tailscale ip -4 | head -n1 || true)
          echo "----------------------------------------------------"
          echo "User      : ${USERNAME} / ${PASSWORD}"
          echo "Desktop   : ${DESKTOP}"
          echo "VNC       : Enabled (port 5901, display :1)"
          echo "VNC pass  : ${PASSWORD}"
          echo "Tailscale : ${TS4}:5901"
          echo "Tip: use any VNC client to connect to the Tailscale IP."
          echo "----------------------------------------------------"

      - name: Keep alive (~6 hours)
        run: |
          set -euo pipefail
          R="${RUNTIME_MINUTES:-355}"
          if [ "$R" -gt 360 ] || [ "$R" -lt 5 ]; then R=355; fi
          END=$(( $(date +%s) + 60*R ))
          while [ "$(date +%s)" -lt "$END" ]; do
            echo "[ $(date +%T) ] alive â€¢ VNC"
            sleep 60
          done
