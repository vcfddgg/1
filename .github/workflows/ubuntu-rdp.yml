name: Ubuntu Desktop via Chrome Remote Desktop (XFCE + Python)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: "Paste the CRD code (starts with 4/...) OR the full command that contains --code=\"4/...\""
        required: true
        default: ""
      crd_pin:
        description: "CRD PIN (6–12 digits)"
        required: true
        default: "123456"
      runtime_minutes:
        description: "How long to keep the session alive (max 360; default 355)"
        required: false
        default: "355"

jobs:
  ubuntu_crd:
    runs-on: ubuntu-22.04   # jammy is stable for desktop on GitHub runners
    timeout-minutes: 370
    env:
      USERNAME: Bullettemporary
      PASSWORD: Bullet@12345
      RUNTIME_MINUTES: ${{ inputs.runtime_minutes }}

    steps:
      - name: Install XFCE desktop & basics
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-goodies xorg dbus-x11 dbus-user-session x11-xserver-utils \
            curl wget unzip jq policykit-1 gvfs locales
          sudo locale-gen en_US.UTF-8
          echo 'LANG=en_US.UTF-8' | sudo tee /etc/default/locale >/dev/null

          # Create desktop user
          if ! id -u "$USERNAME" >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash "$USERNAME"
          fi
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$USERNAME >/dev/null

          # Default session for CRD
          sudo -u "$USERNAME" bash -lc 'printf "%s\n" "exec /usr/bin/xfce4-session" > ~/.chrome-remote-desktop-session'

      - name: Install Chrome Remote Desktop host
        shell: bash
        run: |
          set -e
          # Install CRD host .deb
          curl -fsSL -o /tmp/chrome-remote-desktop.deb \
            https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo dpkg -i /tmp/chrome-remote-desktop.deb || sudo apt-get -f install -y

          # Put user into CRD group
          sudo usermod -aG chrome-remote-desktop "$USERNAME"

      - name: Register CRD (use your code + PIN)
        shell: bash
        run: |
          set -e
          RAW="${{ inputs.crd_code }}"
          PIN="${{ inputs.crd_pin }}"

          # Basic validation
          if ! echo "$PIN" | grep -Eq '^[0-9]{6,12}$'; then
            echo "crd_pin must be 6–12 digits." >&2
            exit 1
          fi

          # Extract code: accept either raw 4/... or full command containing --code="4/..."
          CODE=""
          if echo "$RAW" | grep -q -- '--code='; then
            CODE="$(printf "%s" "$RAW" | sed -n 's/.*--code[= ]\"*\([^\"[:space:]]\+\)\"*.*/\1/p' | head -n1)"
          elif echo "$RAW" | grep -q '^4/'; then
            CODE="$RAW"
          fi

          if [ -z "$CODE" ]; then
            echo "Could not detect CRD code. Paste raw 4/... or a full command containing --code=\"4/...\"" >&2
            exit 1
          fi

          REDIR="https://remotedesktop.google.com/_/oauthredirect"
          NAME="ubuntu-crd-${GITHUB_RUN_ID}"

          # Start host for our user
          sudo -u "$USERNAME" /opt/google/chrome-remote-desktop/start-host \
            --code="$CODE" --redirect-url="$REDIR" --name="$NAME" --pin="$PIN"

          # Enable and start the per-user service
          sudo systemctl enable "chrome-remote-desktop@$USERNAME"
          sudo systemctl restart "chrome-remote-desktop@$USERNAME"

          echo "CRD registered. It should appear in your Chrome Remote Desktop list shortly."

      - name: Install Python 3 + pip (useful tools)
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv python3-dev build-essential
          python3 -m pip install --upgrade pip wheel setuptools
          python3 --version && pip3 --version

      - name: Info & credentials
        shell: bash
        run: |
          echo "---------------------------------------------"
          echo "Login user: $USERNAME"
          echo "Password  : $PASSWORD"
          echo "CRD PIN   : (the one you entered: ${{ inputs.crd_pin }})"
          echo "Session   : XFCE"
          echo "---------------------------------------------"
          echo "Open https://remotedesktop.google.com/access to connect."
          echo "The machine name: ubuntu-crd-${GITHUB_RUN_ID}"
          echo "---------------------------------------------"

      - name: Keep alive (~6 hours)
        shell: bash
        run: |
          # sanitize runtime
          R="${RUNTIME_MINUTES:-355}"
          if ! echo "$R" | grep -Eq '^[0-9]+$'; then R=355; fi
          if [ "$R" -lt 5 ] || [ "$R" -gt 360 ]; then R=355; fi

          END=$(( $(date +%s) + 60 * R ))
          echo "Keeping runner alive for $R minutes (until $(date -d @${END} +%T))."
          while [ $(date +%s) -lt $END ]; do
            systemctl is-active "chrome-remote-desktop@$USERNAME" >/dev/null 2>&1 && STATUS="CRD:active" || STATUS="CRD:starting"
            echo "[$(date +%T)] ${STATUS} • alive"
            sleep 60
          done

      - name: Logs on failure
        if: failure()
        shell: bash
        run: |
          echo "--- CRD journal ---"
          sudo journalctl -u "chrome-remote-desktop@$USERNAME" --since "1 hour ago" -n 200 || true
