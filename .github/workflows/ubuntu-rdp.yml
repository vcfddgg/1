name: Ubuntu GNOME + VNC (Tailscale, 6h)

on:
  workflow_dispatch:
    inputs:
      tailscale_authkey:
        description: "Tailscale Auth Key (ephemeral or reusable)"
        required: true
      username:
        description: "Login username"
        required: false
        default: "runner"
      password:
        description: "Login password"
        required: false
        default: "runner"
      desktop:
        description: "Desktop (gnome=flashback, gnome-classic, xfce)"
        type: choice
        options: [gnome, gnome-classic, xfce]
        default: "gnome"
      runtime_minutes:
        description: "Minutes to keep session alive (max 360)"
        required: false
        default: "355"

permissions:
  contents: read

jobs:
  vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 370
    env:
      USERNAME: ${{ github.event.inputs.username || 'runner' }}
      PASSWORD: ${{ github.event.inputs.password || 'runner' }}
      TS_AUTHKEY: ${{ github.event.inputs.tailscale_authkey }}
      TS_HOSTNAME: gh-gnome-vnc-${{ github.run_id }}
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '355' }}
      DESKTOP: ${{ github.event.inputs.desktop || 'gnome' }}

    steps:
      - name: Prepare user + sudo
        run: |
          set -euo pipefail
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install desktop + TigerVNC (with GNOME fixes)
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            tigervnc-standalone-server tigervnc-common tigervnc-tools \
            dbus-x11 xorg x11-xserver-utils

          if [ "${DESKTOP}" = "xfce" ]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
              xfce4 xfce4-goodies
            SESSION_CMD='startxfce4'
          else
            # GNOME stack + Flashback (Metacity) for headless reliability
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
              gnome-session gnome-shell gnome-terminal gnome-control-center \
              gdm3 gnome-session-flashback gnome-panel metacity nautilus \
              gnome-tweaks gnome-shell-extension-prefs

            # Force Xorg (no Wayland)
            sudo sed -i 's/^#\?WaylandEnable=.*/WaylandEnable=false/' /etc/gdm3/custom.conf || true

            # Desktop choice
            if [ "${DESKTOP}" = "gnome-classic" ]; then
              SESSION_CMD='dbus-launch gnome-session --session=gnome-classic'
            else
              # default "gnome" uses Flashback Metacity
              SESSION_CMD='dbus-launch gnome-session --session=gnome-flashback-metacity'
            fi

            # Hardening to avoid “Oh no!”: kill animations & extensions in headless env
            sudo -u ${USERNAME} dbus-launch gsettings set org.gnome.shell disable-user-extensions true || true
            sudo -u ${USERNAME} dbus-launch gsettings set org.gnome.desktop.interface enable-animations false || true
            sudo -u ${USERNAME} dbus-launch gsettings set org.gnome.desktop.session idle-delay 0 || true
            sudo -u ${USERNAME} dbus-launch gsettings set org.gnome.mutter check-alive-timeout 0 || true
          fi

          # VNC password and Xauth
          sudo -u ${USERNAME} mkdir -p /home/${USERNAME}/.vnc
          echo "${PASSWORD}" | vncpasswd -f | sudo tee /home/${USERNAME}/.vnc/passwd >/dev/null
          sudo chmod 600 /home/${USERNAME}/.vnc/passwd
          sudo touch /home/${USERNAME}/.Xauthority
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc /home/${USERNAME}/.Xauthority

          # Robust xstartup to prevent black screen
          cat <<'EOF' | sudo tee /home/${USERNAME}/.vnc/xstartup >/dev/null
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS

          # XDG runtime dir is required by GNOME components
          export XDG_RUNTIME_DIR="/run/user/$(id -u)"
          mkdir -p "$XDG_RUNTIME_DIR"; chmod 700 "$XDG_RUNTIME_DIR" 2>/dev/null || true

          export XDG_SESSION_TYPE=x11
          export XDG_CONFIG_DIRS=/etc/xdg
          export XAUTHORITY="$HOME/.Xauthority"
          xrdb -merge "$HOME/.Xresources" 2>/dev/null || true

          # Start a D-Bus session and the chosen desktop
          if command -v gnome-session >/dev/null 2>&1; then
            # GNOME/Flashback path
            exec ${SESSION_CMD}
          else
            # Fallback to XFCE if GNOME not present
            exec startxfce4
          fi
          EOF
          sudo chmod +x /home/${USERNAME}/.vnc/xstartup
          # Also provide .xsession for completeness (not used by TigerVNC but harmless)
          echo "exec ${SESSION_CMD:-startxfce4}" | sudo tee /home/${USERNAME}/.xsession >/dev/null
          sudo chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.xsession

      - name: Install + bring up Tailscale
        run: |
          set -euo pipefail
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          sudo tailscale up --authkey "${TS_AUTHKEY}" --hostname "${TS_HOSTNAME}"
          sudo tailscale status || true

      - name: Start TigerVNC on :1 (5901)
        run: |
          set -euo pipefail
          sudo -u ${USERNAME} vncserver -kill :1 >/dev/null 2>&1 || true
          # Start with our xstartup (ensures desktop session starts), listen on all IFs
          sudo -u ${USERNAME} vncserver :1 -geometry 1280x800 -depth 24 -localhost no -xstartup /home/${USERNAME}/.vnc/xstartup
          sleep 3
          pgrep -a Xvnc || true

      - name: Connection info
        run: |
          set -euo pipefail
          TS4=$(tailscale ip -4 | head -n1 || true)
          echo "----------------------------------------------------"
          echo "User      : ${USERNAME} / ${PASSWORD}"
          echo "Desktop   : ${DESKTOP}"
          echo "VNC       : Enabled (port 5901, display :1)"
          echo "VNC pass  : ${PASSWORD}"
          echo "Tailscale : ${TS4}:5901"
          echo "Use any VNC client -> Tailscale IPv4 above."
          echo "----------------------------------------------------"

      - name: Keep alive (~6 hours)
        run: |
          set -euo pipefail
          R="${RUNTIME_MINUTES:-355}"
          if [ "$R" -gt 360 ] || [ "$R" -lt 5 ]; then R=355; fi
          END=$(( $(date +%s) + 60*R ))
          while [ "$(date +%s)" -lt "$END" ]; do
            echo "[ $(date +%T) ] alive • VNC"
            sleep 60
          done
