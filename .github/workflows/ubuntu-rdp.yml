name: Xfce + Tailscale + VNC (Fast & Stable v8)

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth key (paste here)"
        required: true
      username:
        description: "Linux username for desktop login"
        required: false
        default: "runner"
      password:
        description: "Password for the user, VNC access"
        required: false
        default: "runner"
      runtime_minutes:
        description: "Workflow runtime (max 355)"
        required: false
        default: "355"

permissions:
  contents: read

jobs:
  gui-runner:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      USERNAME: ${{ inputs.username }}
      PASSWORD: ${{ inputs.password }}
      TS_AUTHKEY: ${{ inputs.ts_authkey }}
      RUNTIME_MINUTES: ${{ inputs.runtime_minutes }}
      HOSTNAME: xfce-${{ github.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install minimal desktop + VNC + tools
        run: |
          set -eux
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}
          sudo apt-get update
          # minimal xfce session (headless)
          sudo apt-get install -y xfce4-session xfce4-panel xfce4-terminal xfdesktop4 xorg dbus-x11 tigervnc-standalone-server xvfb curl jq net-tools

      - name: Start Xvfb and prepare display
        run: |
          set -eux
          sudo Xvfb :99 -screen 0 1366x768x24 >/tmp/xvfb.log 2>&1 &
          echo "DISPLAY=:99" | sudo tee -a /etc/environment
          export DISPLAY=:99
          sleep 2

      - name: Configure and start VNC
        run: |
          set -eux
          mkdir -p /home/${USERNAME}/.vnc
          printf '%s\n%s\n\n' "${PASSWORD}" "${PASSWORD}" | sudo -u ${USERNAME} vncpasswd
          sudo -u ${USERNAME} bash -lc 'cat > ~/.vnc/xstartup <<EOF
#!/bin/sh
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
export DISPLAY=:99
xfce4-session &
EOF'
          sudo -u ${USERNAME} chmod +x /home/${USERNAME}/.vnc/xstartup
          sudo -u ${USERNAME} vncserver -kill :1 || true
          sudo -u ${USERNAME} vncserver :1 -geometry 1366x768 -localhost no
          echo "âœ… VNC started on port 5901 (display :1)"

      - name: Install and start Tailscale
        run: |
          set -eux
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo nohup /usr/sbin/tailscaled --state=mem: --socket=/run/tailscaled.sock >/tmp/tailscaled.log 2>&1 &
          sudo -E tailscale up --reset --authkey="${TS_AUTHKEY}" --hostname="${HOSTNAME}" --ssh
          tailscale ip || true

      - name: Connection Info
        run: |
          ts_ip=$(tailscale ip -4 | head -n1 || echo "N/A")
          echo "===== CONNECTION INFO ====="
          echo "Tailscale IPv4: ${ts_ip}"
          echo "Username: ${USERNAME}"
          echo "Password: ${PASSWORD}"
          echo "VNC port: 5901"
          echo "============================"

      - name: Keep alive
        run: |
          mins=${RUNTIME_MINUTES:-355}
          echo "Keeping alive for $mins minutes..."
          for i in $(seq 1 $mins); do
            echo "Minute $i / $mins - $(date -u +%F_%T)"
            sleep 60
          done

      - name: Cleanup
        if: always()
        run: |
          sudo -u ${USERNAME} vncserver -kill :1 || true
