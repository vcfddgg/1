name: Ubuntu Desktop (GNOME Flashback + VNC + Tailscale)

on:
  workflow_dispatch:
    inputs:
      tailscale_authkey:
        description: "Tailscale Auth Key (ephemeral or reusable)"
        required: true
      username:
        description: "Login username"
        required: false
        default: "runner"
      password:
        description: "Login password"
        required: false
        default: "runner"
      runtime_minutes:
        description: "Minutes to keep alive (max 360)"
        required: false
        default: "355"

permissions:
  contents: read

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 370
    env:
      USERNAME: ${{ github.event.inputs.username || 'runner' }}
      PASSWORD: ${{ github.event.inputs.password || 'runner' }}
      TS_AUTHKEY: ${{ github.event.inputs.tailscale_authkey }}
      TS_HOSTNAME: gh-gnome-flashback-${{ github.run_id }}
      RUNTIME_MINUTES: ${{ github.event.inputs.runtime_minutes || '355' }}

    steps:
      - name: Setup user
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install GNOME Flashback + TigerVNC
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            gnome-session-flashback gnome-panel metacity nautilus \
            gnome-terminal dbus-x11 tigervnc-standalone-server tigervnc-common tigervnc-tools \
            x11-xserver-utils policykit-1

          # Disable Wayland, force Xorg
          sudo sed -i 's/^#\?WaylandEnable=.*/WaylandEnable=false/' /etc/gdm3/custom.conf || true

          # Force software rendering
          sudo apt-get install -y -qq mesa-utils
          sudo bash -c 'echo "export LIBGL_ALWAYS_SOFTWARE=1" >> /etc/environment'
          sudo bash -c 'echo "export GDK_BACKEND=x11" >> /etc/environment'

          # VNC setup
          sudo -u ${USERNAME} mkdir -p /home/${USERNAME}/.vnc
          echo "${PASSWORD}" | vncpasswd -f | sudo tee /home/${USERNAME}/.vnc/passwd >/dev/null
          sudo chmod 600 /home/${USERNAME}/.vnc/passwd
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc

          # xstartup file
          cat <<'EOF' | sudo tee /home/${USERNAME}/.vnc/xstartup >/dev/null
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          export XDG_SESSION_TYPE=x11
          export XAUTHORITY="$HOME/.Xauthority"
          export LIBGL_ALWAYS_SOFTWARE=1
          export GDK_BACKEND=x11
          xrdb $HOME/.Xresources
          xsetroot -solid grey
          dbus-launch --exit-with-session gnome-session --session=gnome-flashback-metacity &
          EOF
          sudo chmod +x /home/${USERNAME}/.vnc/xstartup
          sudo chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc/xstartup

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          sudo tailscale up --authkey "${TS_AUTHKEY}" --hostname "${TS_HOSTNAME}"
          sudo tailscale status || true

      - name: Start VNC Server
        run: |
          sudo -u ${USERNAME} vncserver -kill :1 >/dev/null 2>&1 || true
          sudo -u ${USERNAME} vncserver :1 -geometry 1280x800 -depth 24 -localhost no
          echo "VNC started on port 5901"
          tail -n 20 /home/${USERNAME}/.vnc/*.log || true

      - name: Connection Info
        run: |
          TS4=$(tailscale ip -4 | head -n1)
          echo "----------------------------------------------------"
          echo "Username : ${USERNAME}"
          echo "Password : ${PASSWORD}"
          echo "VNC Port : 5901"
          echo "Connect  : ${TS4}:5901"
          echo "----------------------------------------------------"

      - name: Keep Alive (~6 hours)
        run: |
          R="${RUNTIME_MINUTES:-355}"
          END=$(( $(date +%s) + 60*R ))
          while [ "$(date +%s)" -lt "$END" ]; do
            echo "[ $(date +%T) ] alive"
            sleep 60
          done
